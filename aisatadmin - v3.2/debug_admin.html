<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --white: #ffffff;
            --light-bg: #f5f8fb;
            --border-color: rgba(44, 62, 80, 0.1);
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-muted: rgba(44, 62, 80, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-muted);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .section {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .admin-table th,
        .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-table th {
            background-color: var(--light-bg);
            font-weight: 600;
            color: var(--secondary);
        }

        .admin-table tr:hover {
            background-color: var(--light-bg);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--white);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-success {
            background-color: var(--success-color);
            color: var(--white);
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .password-field {
            position: relative;
            display: inline-block;
        }

        .password-toggle {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            margin-left: 5px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-controls input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex: 1;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: var(--text-muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary);
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            color: var(--secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Debug Admin Management</h1>
            <p>Comprehensive admin management and debugging tools for AISAT Admin System</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="window.location.href='sidepanel.html'">
                    <i class="fas fa-arrow-left"></i> Back to Main Panel
                </button>
                <button class="btn btn-warning" onclick="window.location.href='auth.html'">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalAdmins">-</div>
                <div class="stat-label">Total Admins</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAdmins">-</div>
                <div class="stat-label">Active Admins</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="systemStatus">-</div>
                <div class="stat-label">System Status</div>
            </div>
        </div>

        <!-- Admin Management Section -->
        <div class="section">
            <h2><i class="fas fa-users-cog"></i> Admin Management</h2>
            
            <div class="search-controls">
                <input type="text" id="adminSearch" placeholder="Search admins...">
                <button class="btn btn-primary" onclick="loadAdmins()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-success" onclick="showAddAdminModal()">
                    <i class="fas fa-plus"></i> Add Admin
                </button>
            </div>

            <div id="adminTableContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i> Loading admins...
                </div>
            </div>
        </div>

        <!-- System Debug Section -->
        <div class="section">
            <h2><i class="fas fa-bug"></i> System Debug</h2>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="checkSystemHealth()">
                    <i class="fas fa-heartbeat"></i> System Health
                </button>
                <button class="btn btn-warning" onclick="testAPIEndpoints()">
                    <i class="fas fa-network-wired"></i> Test API
                </button>
                <button class="btn btn-danger" onclick="clearAllSessions()">
                    <i class="fas fa-trash"></i> Clear All Sessions
                </button>
                <button class="btn btn-warning" onclick="clearCurrentSession()">
                    <i class="fas fa-user-times"></i> Clear Current Session
                </button>
                <button class="btn btn-danger" onclick="showSessionStatus()">
                    <i class="fas fa-eye"></i> Show Session Status
                </button>
                <button class="btn btn-primary" onclick="exportAdminData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>

            <div id="debugOutput" class="debug-info" style="display: none;"></div>
        </div>

        <!-- Authentication Status -->
        <div class="section">
            <h2><i class="fas fa-key"></i> Authentication Status</h2>
            <div id="authStatus">
                <div class="loading">
                    <i class="fas fa-spinner"></i> Checking authentication...
                </div>
            </div>
        </div>

        <!-- Current Session Info -->
        <div class="section">
            <h2><i class="fas fa-user-circle"></i> Current Session</h2>
            <div id="sessionInfo">
                <div class="loading">
                    <i class="fas fa-spinner"></i> Loading session info...
                </div>
            </div>
        </div>
    </div>

    <!-- Add Admin Modal -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Admin</h3>
                <span class="close" onclick="closeModal('addAdminModal')">&times;</span>
            </div>
            <form id="addAdminForm">
                <div class="form-group">
                    <label for="adminName">Full Name</label>
                    <input type="text" id="adminName" required>
                </div>
                <div class="form-group">
                    <label for="adminEmail">Email</label>
                    <input type="email" id="adminEmail" required>
                </div>
                <div class="form-group">
                    <label for="adminIdNo">ID Number</label>
                    <input type="text" id="adminIdNo" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div class="form-group">
                    <label for="adminContact">Contact Number</label>
                    <input type="text" id="adminContact">
                </div>
                <div class="form-group">
                    <label for="adminRoom">Room Name</label>
                    <input type="text" id="adminRoom">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Create Admin
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('addAdminModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Admin Modal -->
    <div id="editAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Admin</h3>
                <span class="close" onclick="closeModal('editAdminModal')">&times;</span>
            </div>
            <form id="editAdminForm">
                <input type="hidden" id="editAdminId">
                <div class="form-group">
                    <label for="editAdminName">Full Name</label>
                    <input type="text" id="editAdminName" required>
                </div>
                <div class="form-group">
                    <label for="editAdminEmail">Email</label>
                    <input type="email" id="editAdminEmail" required>
                </div>
                <div class="form-group">
                    <label for="editAdminIdNo">ID Number</label>
                    <input type="text" id="editAdminIdNo" required>
                </div>
                <div class="form-group">
                    <label for="editAdminContact">Contact Number</label>
                    <input type="text" id="editAdminContact">
                </div>
                <div class="form-group">
                    <label for="editAdminRoom">Room Name</label>
                    <input type="text" id="editAdminRoom">
                </div>
                <div class="form-group">
                    <label for="editAdminPassword">New Password (leave blank to keep current)</label>
                    <input type="password" id="editAdminPassword">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Update Admin
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('editAdminModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://jimboyaczon.pythonanywhere.com";
        let currentAdmins = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadAuthStatus();
            loadAdmins();
            loadSessionInfo();
            loadStatistics();
            
            // Setup search functionality
            document.getElementById('adminSearch').addEventListener('input', function(e) {
                filterAdmins(e.target.value);
            });

            // Setup form submissions
            document.getElementById('addAdminForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addAdmin();
            });

            document.getElementById('editAdminForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateAdmin();
            });
        });

        function checkAuthStatus() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                showAlert('No authentication token found. Some features may be limited.', 'warning');
                // Don't redirect, just show warning
                return;
            }
        }

        async function loadAuthStatus() {
            const token = localStorage.getItem('userToken');
            const container = document.getElementById('authStatus');

            if (!token) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Not Authenticated</strong><br>
                        No authentication token found. You can view demo data but cannot perform admin operations.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="window.location.href='auth.html'">
                            <i class="fas fa-sign-in-alt"></i> Login Now
                        </button>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    container.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            <strong>Authenticated</strong><br>
                            Token is valid. You have full access to admin operations.
                        </div>
                        <div class="debug-info">
                            <strong>Token Info:</strong><br>
                            Valid: ${data.valid ? 'Yes' : 'No'}<br>
                            Admin: ${data.is_admin ? 'Yes' : 'No'}<br>
                            Name: ${data.name || 'N/A'}<br>
                            Token: ${token.substring(0, 20)}...
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> 
                            <strong>Invalid Token</strong><br>
                            Authentication token is invalid or expired.
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-warning" onclick="window.location.href='auth.html'">
                                <i class="fas fa-sign-in-alt"></i> Login Again
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Connection Error</strong><br>
                        Could not verify token: ${error.message}
                    </div>
                    <div class="debug-info">
                        <strong>Token:</strong> ${token.substring(0, 20)}...
                    </div>
                `;
            }
        }

        async function loadAdmins() {
            const token = localStorage.getItem('userToken');
            const container = document.getElementById('adminTableContainer');
            
            try {
                container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Loading admins...</div>';
                
                // Prepare headers
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Try to get admin list from API
                const response = await fetch(`${API_BASE_URL}/api/admin/list`, {
                    headers: headers
                });

                if (response.ok) {
                    const admins = await response.json();
                    currentAdmins = admins;
                    displayAdmins(admins);
                } else if (response.status === 404) {
                    // If endpoint doesn't exist, try to get current admin profile
                    const profileResponse = await fetch(`${API_BASE_URL}/api/admin/profile`, {
                        headers: headers
                    });
                    
                    if (profileResponse.ok) {
                        const admin = await profileResponse.json();
                        currentAdmins = [admin];
                        displayAdmins([admin]);
                    } else {
                        throw new Error('Failed to load admin data');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error loading admins:', error);
                
                // If no token or API error, show demo data for testing
                if (!token || error.message.includes('401') || error.message.includes('403')) {
                    const demoAdmins = [
                        {
                            id: 1,
                            full_name: 'Demo Admin 1',
                            email: 'admin1@demo.com',
                            id_no: 'ADM001',
                            contact_no: '+1234567890',
                            room_name: 'Room 101',
                            is_active: 'yes',
                            password: 'demo123'
                        },
                        {
                            id: 2,
                            full_name: 'Demo Admin 2',
                            email: 'admin2@demo.com',
                            id_no: 'ADM002',
                            contact_no: '+0987654321',
                            room_name: 'Room 102',
                            is_active: 'no',
                            password: 'demo456'
                        }
                    ];
                    currentAdmins = demoAdmins;
                    displayAdmins(demoAdmins);
                    showAlert('Showing demo data (no authentication token found)', 'warning');
                } else {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Error loading admins: ${error.message}
                        </div>
                        <div class="debug-info">
                            <strong>Debug Info:</strong><br>
                            API URL: ${API_BASE_URL}/api/admin/list<br>
                            Token: ${token ? 'Present' : 'Missing'}<br>
                            Error: ${error.message}
                        </div>
                    `;
                }
            }
        }

        function displayAdmins(admins) {
            const container = document.getElementById('adminTableContainer');
            
            if (admins.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No admins found</div>';
                return;
            }

            const table = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>ID Number</th>
                            <th>Contact</th>
                            <th>Room</th>
                            <th>Status</th>
                            <th>Password</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${admins.map(admin => `
                            <tr>
                                <td>${admin.id || 'N/A'}</td>
                                <td>${admin.full_name || admin.name || 'N/A'}</td>
                                <td>${admin.email || 'N/A'}</td>
                                <td>${admin.id_no || 'N/A'}</td>
                                <td>${admin.contact_no || 'N/A'}</td>
                                <td>${admin.room_name || 'N/A'}</td>
                                <td>
                                    <span class="status-badge ${admin.is_active === 'yes' ? 'status-active' : 'status-inactive'}">
                                        ${admin.is_active === 'yes' ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <div class="password-field">
                                        <span class="password-text" data-password="${admin.password || 'N/A'}">${admin.password || 'N/A'}</span>
                                        <button class="password-toggle btn-small" onclick="togglePassword(this)">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary btn-small" onclick="editAdmin(${admin.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="deleteAdmin(${admin.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <button class="btn btn-warning btn-small" onclick="resetPassword(${admin.id})">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="clearAdminSession(${admin.id}, '${admin.full_name || admin.name}')">
                                            <i class="fas fa-sign-out-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function filterAdmins(searchTerm) {
            const filtered = currentAdmins.filter(admin => 
                admin.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                admin.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                admin.id_no?.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayAdmins(filtered);
        }

        function togglePassword(button) {
            const passwordText = button.previousElementSibling;
            const icon = button.querySelector('i');
            const password = passwordText.dataset.password;
            
            if (passwordText.textContent === password) {
                passwordText.textContent = '••••••••';
                icon.className = 'fas fa-eye';
            } else {
                passwordText.textContent = password;
                icon.className = 'fas fa-eye-slash';
            }
        }

        async function addAdmin() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                showAlert('Authentication required to create admin', 'danger');
                return;
            }
            
            const formData = {
                full_name: document.getElementById('adminName').value,
                email: document.getElementById('adminEmail').value,
                id_no: document.getElementById('adminIdNo').value,
                password: document.getElementById('adminPassword').value,
                contact_no: document.getElementById('adminContact').value,
                room_name: document.getElementById('adminRoom').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert('Admin created successfully!', 'success');
                    closeModal('addAdminModal');
                    document.getElementById('addAdminForm').reset();
                    loadAdmins();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create admin');
                }
            } catch (error) {
                showAlert(`Error creating admin: ${error.message}`, 'danger');
            }
        }

        async function editAdmin(adminId) {
            const admin = currentAdmins.find(a => a.id === adminId);
            if (!admin) {
                showAlert('Admin not found', 'danger');
                return;
            }

            document.getElementById('editAdminId').value = admin.id;
            document.getElementById('editAdminName').value = admin.full_name || admin.name || '';
            document.getElementById('editAdminEmail').value = admin.email || '';
            document.getElementById('editAdminIdNo').value = admin.id_no || '';
            document.getElementById('editAdminContact').value = admin.contact_no || '';
            document.getElementById('editAdminRoom').value = admin.room_name || '';
            document.getElementById('editAdminPassword').value = '';

            document.getElementById('editAdminModal').style.display = 'block';
        }

        async function updateAdmin() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                showAlert('Authentication required to update admin', 'danger');
                return;
            }
            
            const adminId = document.getElementById('editAdminId').value;
            const formData = {
                full_name: document.getElementById('editAdminName').value,
                email: document.getElementById('editAdminEmail').value,
                id_no: document.getElementById('editAdminIdNo').value,
                contact_no: document.getElementById('editAdminContact').value,
                room_name: document.getElementById('editAdminRoom').value
            };

            const newPassword = document.getElementById('editAdminPassword').value;
            if (newPassword) {
                formData.new_password = newPassword;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/update/${adminId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showAlert('Admin updated successfully!', 'success');
                    closeModal('editAdminModal');
                    loadAdmins();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update admin');
                }
            } catch (error) {
                showAlert(`Error updating admin: ${error.message}`, 'danger');
            }
        }

        async function deleteAdmin(adminId) {
            if (!confirm('Are you sure you want to delete this admin? This action cannot be undone.')) {
                return;
            }

            const token = localStorage.getItem('userToken');
            if (!token) {
                showAlert('Authentication required to delete admin', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/delete/${adminId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showAlert('Admin deleted successfully!', 'success');
                    loadAdmins();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete admin');
                }
            } catch (error) {
                showAlert(`Error deleting admin: ${error.message}`, 'danger');
            }
        }

        async function resetPassword(adminId) {
            const newPassword = prompt('Enter new password for admin:');
            if (!newPassword) return;

            const token = localStorage.getItem('userToken');
            if (!token) {
                showAlert('Authentication required to reset password', 'danger');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/reset-password/${adminId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ password: newPassword })
                });

                if (response.ok) {
                    showAlert('Password reset successfully!', 'success');
                    loadAdmins();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reset password');
                }
            } catch (error) {
                showAlert(`Error resetting password: ${error.message}`, 'danger');
            }
        }

        async function loadSessionInfo() {
            const token = localStorage.getItem('userToken');
            const container = document.getElementById('sessionInfo');

            if (!token) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        No authentication token found. Session info unavailable.
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const admin = await response.json();
                    container.innerHTML = `
                        <div class="admin-table">
                            <table>
                                <tr>
                                    <td><strong>Admin ID:</strong></td>
                                    <td>${admin.id || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>${admin.full_name || admin.name || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>${admin.email || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>ID Number:</strong></td>
                                    <td>${admin.id_no || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        <span class="status-badge ${admin.is_active === 'yes' ? 'status-active' : 'status-inactive'}">
                                            ${admin.is_active === 'yes' ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Token:</strong></td>
                                    <td>
                                        <div class="password-field">
                                            <span class="password-text" data-password="${token}">••••••••••••••••</span>
                                            <button class="password-toggle btn-small" onclick="togglePassword(this)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    `;
                } else {
                    throw new Error('Failed to load session info');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error loading session info: ${error.message}
                    </div>
                `;
            }
        }

        async function loadStatistics() {
            const token = localStorage.getItem('userToken');
            
            try {
                // Prepare headers
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                // Load admin count
                const adminResponse = await fetch(`${API_BASE_URL}/api/admin/list`, {
                    headers: headers
                });
                
                if (adminResponse.ok) {
                    const admins = await adminResponse.json();
                    document.getElementById('totalAdmins').textContent = admins.length;
                    document.getElementById('activeAdmins').textContent = 
                        admins.filter(a => a.is_active === 'yes').length;
                } else if (!token) {
                    // Show demo statistics when no authentication
                    document.getElementById('totalAdmins').textContent = '2';
                    document.getElementById('activeAdmins').textContent = '1';
                }

                // Load user count (if endpoint exists)
                try {
                    const userResponse = await fetch(`${API_BASE_URL}/api/users/count`, {
                        headers: headers
                    });
                    
                    if (userResponse.ok) {
                        const userCount = await userResponse.json();
                        document.getElementById('totalUsers').textContent = userCount.count || 'N/A';
                    } else {
                        document.getElementById('totalUsers').textContent = 'N/A';
                    }
                } catch {
                    document.getElementById('totalUsers').textContent = 'N/A';
                }

                // System status
                if (!token) {
                    document.getElementById('totalUsers').textContent = '150';
                    document.getElementById('systemStatus').textContent = 'Demo Mode';
                } else {
                    document.getElementById('systemStatus').textContent = 'Online';
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                document.getElementById('totalAdmins').textContent = 'Error';
                document.getElementById('activeAdmins').textContent = 'Error';
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('systemStatus').textContent = 'Offline';
            }
        }

        async function checkSystemHealth() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Checking system health...</div>';

            const endpoints = [
                '/api/auth/verify',
                '/api/admin/profile',
                '/api/admin/list',
                '/api/users/count'
            ];

            let results = [];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                        }
                    });
                    
                    results.push({
                        endpoint,
                        status: response.status,
                        ok: response.ok,
                        error: null
                    });
                } catch (error) {
                    results.push({
                        endpoint,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                }
            }

            const healthReport = results.map(result => 
                `${result.endpoint}: ${result.ok ? '✅ OK' : '❌ FAILED'} (${result.status})${result.error ? ` - ${result.error}` : ''}`
            ).join('\n');

            debugOutput.innerHTML = `
                <strong>System Health Report:</strong><br>
                <pre>${healthReport}</pre>
                <br>
                <strong>Timestamp:</strong> ${new Date().toLocaleString()}
            `;
        }

        async function testAPIEndpoints() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Testing API endpoints...</div>';

            const tests = [
                { name: 'Authentication', endpoint: '/api/auth/verify', method: 'GET' },
                { name: 'Admin Profile', endpoint: '/api/admin/profile', method: 'GET' },
                { name: 'Admin List', endpoint: '/api/admin/list', method: 'GET' },
                { name: 'Create Admin', endpoint: '/api/admin/create', method: 'POST' },
                { name: 'Update Admin', endpoint: '/api/admin/update/1', method: 'PUT' },
                { name: 'Delete Admin', endpoint: '/api/admin/delete/1', method: 'DELETE' }
            ];

            let results = [];

            for (const test of tests) {
                try {
                    const response = await fetch(`${API_BASE_URL}${test.endpoint}`, {
                        method: test.method,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('userToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: test.method !== 'GET' ? JSON.stringify({}) : undefined
                    });
                    
                    results.push({
                        name: test.name,
                        endpoint: test.endpoint,
                        method: test.method,
                        status: response.status,
                        ok: response.ok
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        endpoint: test.endpoint,
                        method: test.method,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                }
            }

            const testReport = results.map(result => 
                `${result.name} (${result.method} ${result.endpoint}): ${result.ok ? '✅ Available' : '❌ Not Available'} (${result.status})`
            ).join('\n');

            debugOutput.innerHTML = `
                <strong>API Endpoint Test Results:</strong><br>
                <pre>${testReport}</pre>
                <br>
                <strong>Timestamp:</strong> ${new Date().toLocaleString()}
            `;
        }

        async function clearAllSessions() {
            if (!confirm('Are you sure you want to clear all admin sessions? This will log out all admins and clear all stored credentials.')) {
                return;
            }

            const debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Clearing all sessions...</div>';

            const results = [];
            const token = localStorage.getItem('userToken');

            // Step 1: Clear current user's session
            results.push('=== Step 1: Clearing Current User Session ===');
            
            // Clear localStorage
            try {
                localStorage.clear();
                sessionStorage.clear();
                results.push('✅ localStorage and sessionStorage cleared');
            } catch (error) {
                results.push(`❌ Error clearing localStorage: ${error.message}`);
            }

            // Clear cookies
            try {
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                results.push('✅ Cookies cleared');
            } catch (error) {
                results.push(`❌ Error clearing cookies: ${error.message}`);
            }

            // Step 2: Set current admin as inactive (if we have token)
            if (token) {
                results.push('\n=== Step 2: Setting Current Admin Inactive ===');
                
                try {
                    // Try multiple approaches like in main.py
                    const approaches = [
                        {
                            name: 'Authenticated update-active-status',
                            url: `${API_BASE_URL}/api/admin/update-active-status`,
                            method: 'POST',
                            body: { is_active: 'no' }
                        },
                        {
                            name: 'Direct set_admin_active',
                            url: `${API_BASE_URL}/api/set_admin_active?is_active=no`,
                            method: 'GET'
                        },
                        {
                            name: 'Admin logout endpoint',
                            url: `${API_BASE_URL}/api/admin_logout`,
                            method: 'GET'
                        }
                    ];

                    let success = false;
                    for (const approach of approaches) {
                        try {
                            const response = await fetch(approach.url, {
                                method: approach.method,
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: approach.method === 'POST' ? JSON.stringify(approach.body) : undefined
                            });
                            
                            if (response.ok) {
                                results.push(`✅ ${approach.name}: Success`);
                                success = true;
                                break;
                            } else {
                                results.push(`⚠️ ${approach.name}: Failed (${response.status})`);
                            }
                        } catch (error) {
                            results.push(`❌ ${approach.name}: Error - ${error.message}`);
                        }
                    }
                    
                    if (!success) {
                        results.push('⚠️ Could not set current admin as inactive via API');
                    }
                } catch (error) {
                    results.push(`❌ Error setting admin inactive: ${error.message}`);
                }
            } else {
                results.push('\n=== Step 2: No current token found, skipping admin deactivation ===');
            }

            // Step 3: Clear all admin sessions via API
            results.push('\n=== Step 3: Clearing All Admin Sessions via API ===');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/clear-sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token || ''}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    results.push('✅ All admin sessions cleared via API');
                } else if (response.status === 404) {
                    results.push('⚠️ Clear sessions API endpoint not found (404)');
                } else {
                    results.push(`⚠️ Clear sessions API failed: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                results.push(`❌ Error calling clear sessions API: ${error.message}`);
            }

            // Step 4: Force logout all admins by setting them inactive
            results.push('\n=== Step 4: Force Logout All Admins ===');
            
            try {
                // Get list of admins and set them all inactive
                const adminResponse = await fetch(`${API_BASE_URL}/api/admin/list`, {
                    headers: {
                        'Authorization': `Bearer ${token || ''}`
                    }
                });

                if (adminResponse.ok) {
                    const admins = await adminResponse.json();
                    results.push(`📋 Found ${admins.length} admins to deactivate`);
                    
                    for (const admin of admins) {
                        try {
                            const deactivateResponse = await fetch(`${API_BASE_URL}/api/admin/update-active-status`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token || ''}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ 
                                    admin_id: admin.id,
                                    is_active: 'no' 
                                })
                            });
                            
                            if (deactivateResponse.ok) {
                                results.push(`✅ Admin ${admin.full_name || admin.name} (ID: ${admin.id}) deactivated`);
                            } else {
                                results.push(`⚠️ Failed to deactivate admin ${admin.full_name || admin.name}: ${deactivateResponse.status}`);
                            }
                        } catch (error) {
                            results.push(`❌ Error deactivating admin ${admin.full_name || admin.name}: ${error.message}`);
                        }
                    }
                } else {
                    results.push(`⚠️ Could not fetch admin list: ${adminResponse.status}`);
                }
            } catch (error) {
                results.push(`❌ Error in force logout process: ${error.message}`);
            }

            // Step 5: Clear any remaining session data
            results.push('\n=== Step 5: Final Cleanup ===');
            
            try {
                // Clear any remaining localStorage items
                const remainingKeys = Object.keys(localStorage);
                if (remainingKeys.length > 0) {
                    remainingKeys.forEach(key => localStorage.removeItem(key));
                    results.push(`✅ Cleared ${remainingKeys.length} remaining localStorage items`);
                } else {
                    results.push('✅ No remaining localStorage items found');
                }

                // Clear any remaining sessionStorage items
                const remainingSessionKeys = Object.keys(sessionStorage);
                if (remainingSessionKeys.length > 0) {
                    remainingSessionKeys.forEach(key => sessionStorage.removeItem(key));
                    results.push(`✅ Cleared ${remainingSessionKeys.length} remaining sessionStorage items`);
                } else {
                    results.push('✅ No remaining sessionStorage items found');
                }

                // Clear any remaining cookies
                const remainingCookies = document.cookie;
                if (remainingCookies) {
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    results.push('✅ Cleared remaining cookies');
                } else {
                    results.push('✅ No remaining cookies found');
                }
            } catch (error) {
                results.push(`❌ Error in final cleanup: ${error.message}`);
            }

            // Step 6: Summary
            results.push('\n=== Session Clear Summary ===');
            results.push(`🕐 Timestamp: ${new Date().toLocaleString()}`);
            results.push('✅ All local session data cleared');
            results.push('✅ All admin sessions should be terminated');
            results.push('🔄 Page will refresh in 3 seconds to complete the process...');

            // Display results
            debugOutput.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Session Clear Operation Completed</strong>
                </div>
                <div class="debug-info">
                    <pre>${results.join('\n')}</pre>
                </div>
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh Page Now
                    </button>
                    <button class="btn btn-warning" onclick="window.location.href='auth.html'">
                        <i class="fas fa-sign-in-alt"></i> Go to Login
                    </button>
                </div>
            `;

            // Auto refresh after 3 seconds
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        async function exportAdminData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/export`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `admin_data_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('Admin data exported successfully!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showAlert(`Error exporting data: ${error.message}`, 'danger');
            }
        }

        function showAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.stats-grid'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        async function clearAdminSession(adminId, adminName) {
            if (!confirm(`Are you sure you want to clear the session for admin "${adminName}"? This will log them out immediately.`)) {
                return;
            }

            const token = localStorage.getItem('userToken');
            if (!token) {
                showAlert('Authentication required to clear admin session', 'danger');
                return;
            }

            try {
                // Try multiple approaches to clear the specific admin session
                const approaches = [
                    {
                        name: 'Set admin inactive',
                        url: `${API_BASE_URL}/api/admin/update-active-status`,
                        method: 'POST',
                        body: { admin_id: adminId, is_active: 'no' }
                    },
                    {
                        name: 'Direct admin logout',
                        url: `${API_BASE_URL}/api/admin_logout?admin_id=${adminId}`,
                        method: 'GET'
                    },
                    {
                        name: 'Set admin active status',
                        url: `${API_BASE_URL}/api/set_admin_active?admin_id=${adminId}&is_active=no`,
                        method: 'GET'
                    }
                ];

                let success = false;
                for (const approach of approaches) {
                    try {
                        const response = await fetch(approach.url, {
                            method: approach.method,
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: approach.method === 'POST' ? JSON.stringify(approach.body) : undefined
                        });
                        
                        if (response.ok) {
                            showAlert(`Session cleared for admin "${adminName}" successfully!`, 'success');
                            success = true;
                            loadAdmins(); // Refresh the admin list
                            break;
                        }
                    } catch (error) {
                        console.error(`Error with ${approach.name}:`, error);
                    }
                }
                
                if (!success) {
                    showAlert(`Failed to clear session for admin "${adminName}". The admin may need to log out manually.`, 'warning');
                }
            } catch (error) {
                showAlert(`Error clearing admin session: ${error.message}`, 'danger');
            }
        }

        async function clearCurrentSession() {
            if (!confirm('Are you sure you want to clear your current session? This will log you out immediately.')) {
                return;
            }

            const debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Clearing current session...</div>';

            const results = [];
            const token = localStorage.getItem('userToken');

            results.push('=== Current Session Clear Operation ===');
            results.push(`🕐 Timestamp: ${new Date().toLocaleString()}`);

            // Step 1: Set current admin as inactive (like in main.py)
            if (token) {
                results.push('\n=== Step 1: Setting Current Admin Inactive ===');
                
                try {
                    // Try multiple approaches like in main.py
                    const approaches = [
                        {
                            name: 'Authenticated update-active-status',
                            url: `${API_BASE_URL}/api/admin/update-active-status`,
                            method: 'POST',
                            body: { is_active: 'no' }
                        },
                        {
                            name: 'Direct set_admin_active',
                            url: `${API_BASE_URL}/api/set_admin_active?is_active=no`,
                            method: 'GET'
                        },
                        {
                            name: 'Admin logout endpoint',
                            url: `${API_BASE_URL}/api/admin_logout`,
                            method: 'GET'
                        }
                    ];

                    let success = false;
                    for (const approach of approaches) {
                        try {
                            const response = await fetch(approach.url, {
                                method: approach.method,
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: approach.method === 'POST' ? JSON.stringify(approach.body) : undefined
                            });
                            
                            if (response.ok) {
                                results.push(`✅ ${approach.name}: Success`);
                                success = true;
                                break;
                            } else {
                                results.push(`⚠️ ${approach.name}: Failed (${response.status})`);
                            }
                        } catch (error) {
                            results.push(`❌ ${approach.name}: Error - ${error.message}`);
                        }
                    }
                    
                    if (!success) {
                        results.push('⚠️ Could not set current admin as inactive via API');
                    }
                } catch (error) {
                    results.push(`❌ Error setting admin inactive: ${error.message}`);
                }
            } else {
                results.push('\n=== Step 1: No current token found, skipping admin deactivation ===');
            }

            // Step 2: Clear all local storage (like QSettings in PyQt5)
            results.push('\n=== Step 2: Clearing Local Storage (QSettings equivalent) ===');
            
            try {
                // Clear localStorage (equivalent to QSettings)
                const localStorageKeys = Object.keys(localStorage);
                localStorageKeys.forEach(key => localStorage.removeItem(key));
                results.push(`✅ Cleared ${localStorageKeys.length} localStorage items`);

                // Clear sessionStorage
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorageKeys.forEach(key => sessionStorage.removeItem(key));
                results.push(`✅ Cleared ${sessionStorageKeys.length} sessionStorage items`);

                // Clear cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                results.push('✅ Cookies cleared');

                // Clear specific credential items (like in main.py)
                const credentialKeys = ['userToken', 'auth_token', 'remember_me', 'idno', 'password', 'admin_name', 'admin_id'];
                credentialKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        results.push(`✅ Removed credential: ${key}`);
                    }
                });

            } catch (error) {
                results.push(`❌ Error clearing local storage: ${error.message}`);
            }

            // Step 3: Summary
            results.push('\n=== Current Session Clear Summary ===');
            results.push('✅ Current user session cleared');
            results.push('✅ Local storage cleared (QSettings equivalent)');
            results.push('✅ Admin should be marked as inactive');
            results.push('🔄 Redirecting to login page in 3 seconds...');

            // Display results
            debugOutput.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <strong>Current Session Cleared Successfully</strong>
                </div>
                <div class="debug-info">
                    <pre>${results.join('\n')}</pre>
                </div>
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="window.location.href='auth.html'">
                        <i class="fas fa-sign-in-alt"></i> Go to Login Now
                    </button>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh Page
                    </button>
                </div>
            `;

            // Auto redirect to login after 3 seconds
            setTimeout(() => {
                window.location.href = 'auth.html';
            }, 3000);
        }

        async function showSessionStatus() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.style.display = 'block';
            debugOutput.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Analyzing session status...</div>';

            const results = [];
            const token = localStorage.getItem('userToken');

            results.push('=== Session Status Analysis ===');
            results.push(`🕐 Timestamp: ${new Date().toLocaleString()}`);

            // Check localStorage
            results.push('\n=== Local Storage Analysis ===');
            const localStorageKeys = Object.keys(localStorage);
            if (localStorageKeys.length > 0) {
                results.push(`📦 Found ${localStorageKeys.length} localStorage items:`);
                localStorageKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    const displayValue = key.includes('token') || key.includes('password') 
                        ? value.substring(0, 20) + '...' 
                        : value;
                    results.push(`  • ${key}: ${displayValue}`);
                });
            } else {
                results.push('📦 No localStorage items found');
            }

            // Check sessionStorage
            results.push('\n=== Session Storage Analysis ===');
            const sessionStorageKeys = Object.keys(sessionStorage);
            if (sessionStorageKeys.length > 0) {
                results.push(`📦 Found ${sessionStorageKeys.length} sessionStorage items:`);
                sessionStorageKeys.forEach(key => {
                    const value = sessionStorage.getItem(key);
                    const displayValue = key.includes('token') || key.includes('password') 
                        ? value.substring(0, 20) + '...' 
                        : value;
                    results.push(`  • ${key}: ${displayValue}`);
                });
            } else {
                results.push('📦 No sessionStorage items found');
            }

            // Check cookies
            results.push('\n=== Cookie Analysis ===');
            if (document.cookie) {
                const cookies = document.cookie.split(';');
                results.push(`🍪 Found ${cookies.length} cookies:`);
                cookies.forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    const displayValue = name.includes('token') || name.includes('password') 
                        ? value.substring(0, 20) + '...' 
                        : value;
                    results.push(`  • ${name}: ${displayValue}`);
                });
            } else {
                results.push('🍪 No cookies found');
            }

            // Check authentication token
            results.push('\n=== Authentication Token Analysis ===');
            if (token) {
                results.push(`🔑 Authentication token found: ${token.substring(0, 20)}...`);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        results.push(`✅ Token is valid`);
                        results.push(`👤 Admin: ${data.is_admin ? 'Yes' : 'No'}`);
                        results.push(`📝 Name: ${data.name || 'N/A'}`);
                        results.push(`🆔 User ID: ${data.id || 'N/A'}`);
                    } else {
                        results.push(`❌ Token is invalid (${response.status})`);
                    }
                } catch (error) {
                    results.push(`❌ Error verifying token: ${error.message}`);
                }
            } else {
                results.push('❌ No authentication token found');
            }

            // Check active admins
            results.push('\n=== Active Admin Analysis ===');
            try {
                const adminResponse = await fetch(`${API_BASE_URL}/api/admin/list`, {
                    headers: {
                        'Authorization': `Bearer ${token || ''}`
                    }
                });

                if (adminResponse.ok) {
                    const admins = await adminResponse.json();
                    const activeAdmins = admins.filter(a => a.is_active === 'yes');
                    const inactiveAdmins = admins.filter(a => a.is_active === 'no');
                    
                    results.push(`📊 Total admins: ${admins.length}`);
                    results.push(`🟢 Active admins: ${activeAdmins.length}`);
                    results.push(`🔴 Inactive admins: ${inactiveAdmins.length}`);
                    
                    if (activeAdmins.length > 0) {
                        results.push('\n🟢 Currently Active Admins:');
                        activeAdmins.forEach(admin => {
                            results.push(`  • ${admin.full_name || admin.name} (ID: ${admin.id})`);
                        });
                    }
                    
                    if (inactiveAdmins.length > 0) {
                        results.push('\n🔴 Currently Inactive Admins:');
                        inactiveAdmins.forEach(admin => {
                            results.push(`  • ${admin.full_name || admin.name} (ID: ${admin.id})`);
                        });
                    }
                } else {
                    results.push(`⚠️ Could not fetch admin list: ${adminResponse.status}`);
                }
            } catch (error) {
                results.push(`❌ Error analyzing admin status: ${error.message}`);
            }

            // Summary
            results.push('\n=== Session Status Summary ===');
            const hasLocalData = localStorageKeys.length > 0 || sessionStorageKeys.length > 0 || document.cookie;
            const hasValidToken = token && true; // We already verified above
            
            if (hasLocalData) {
                results.push('⚠️ Local session data found - may need clearing');
            } else {
                results.push('✅ No local session data found');
            }
            
            if (hasValidToken) {
                results.push('✅ Valid authentication token found');
            } else {
                results.push('❌ No valid authentication token found');
            }

            // Display results
            debugOutput.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Session Status Analysis Complete</strong>
                </div>
                <div class="debug-info">
                    <pre>${results.join('\n')}</pre>
                </div>
                <div class="action-buttons" style="margin-top: 15px;">
                    <button class="btn btn-danger" onclick="clearAllSessions()">
                        <i class="fas fa-trash"></i> Clear All Sessions
                    </button>
                    <button class="btn btn-primary" onclick="loadAdmins()">
                        <i class="fas fa-sync-alt"></i> Refresh Admin List
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
