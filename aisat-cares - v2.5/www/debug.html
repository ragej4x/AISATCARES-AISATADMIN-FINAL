<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AISAT CARES - Debug Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #6b9ac4;
            --primary-light: #97c4e6;
            --primary-dark: #4a7ba7;
            --accent-color: #b6dcfe;
            --wave-color: #8fb8de;
            --light-bg: #e8f4ff;
            --white: #ffffff;
            --text-dark: #2c3e50;
            --text-muted: #7f8c8d;
            --success: #66bb6a;
            --danger: #e57373;
            --warning: #ffb74d;
            --info: #4fc3f7;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .debug-section {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .debug-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .section-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .test-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .test-button:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-success {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
        }

        .status-error {
            background: rgba(229, 115, 115, 0.2);
            color: var(--danger);
        }

        .status-warning {
            background: rgba(255, 183, 77, 0.2);
            color: var(--warning);
        }

        .status-info {
            background: rgba(79, 195, 247, 0.2);
            color: var(--info);
        }

        .result-container {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            max-height: 300px;
            overflow-y: auto;
        }

        .result-container pre {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-light));
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            color: var(--text-dark);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .hourly-chart {
            margin-top: 20px;
            padding: 20px;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--accent-color);
        }

        .time-slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            background: var(--light-bg);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .time-slot.available {
            border-color: var(--success);
            background: rgba(102, 187, 106, 0.1);
        }

        .time-slot.busy {
            border-color: var(--warning);
            background: rgba(255, 183, 77, 0.1);
        }

        .time-slot.full {
            border-color: var(--danger);
            background: rgba(229, 115, 115, 0.1);
        }

        .time-slot.unavailable {
            border-color: var(--text-muted);
            background: rgba(127, 140, 141, 0.1);
            opacity: 0.6;
        }

        .time-slot .time {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        .time-slot .count {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .hourly-bar-chart {
            display: flex;
            align-items: end;
            gap: 8px;
            height: 200px;
            margin: 20px 0;
            padding: 20px 0;
            border-bottom: 2px solid var(--accent-color);
        }

        .hourly-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary-color), var(--primary-light));
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 30px;
            transition: var(--transition);
        }

        .hourly-bar:hover {
            transform: scaleY(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .hourly-bar .label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .hourly-bar .value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .current-hour-indicator {
            background: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(229, 115, 115, 0.1);
            color: var(--danger);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background: rgba(102, 187, 106, 0.1);
            color: var(--success);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid var(--success);
        }

        .auth-section {
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
        }

        .auth-section .section-title {
            color: white;
        }

        .auth-section .section-icon {
            color: white;
        }

        .token-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
            margin-top: 10px;
        }

        .clear-button {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .clear-button:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .debug-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-bug"></i> AISAT CARES Debug Panel</h1>
            <p>Test and monitor all API endpoints and system functionality</p>
        </div>

        <div class="debug-grid">
            <!-- Authentication Section -->
            <div class="debug-section auth-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title"><i class="fas fa-key section-icon"></i> Authentication</h2>
                    </div>
                    <div>
                        <span class="status-indicator status-info" id="auth-status">Ready</span>
                    </div>
                </div>
                
                <div>
                    <button class="test-button" onclick="testLogin()">
                        <i class="fas fa-sign-in-alt"></i> Test Login
                    </button>
                    <button class="test-button" onclick="testTokenVerification()">
                        <i class="fas fa-check-circle"></i> Verify Token
                    </button>
                    <button class="clear-button" onclick="clearAuth()">
                        <i class="fas fa-trash"></i> Clear Token
                    </button>
                </div>

                <div id="auth-result" class="result-container" style="display: none;"></div>
                <div id="token-display" class="token-display" style="display: none;"></div>
            </div>

            <!-- User Management Section -->
            <div class="debug-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title"><i class="fas fa-users section-icon"></i> User Management</h2>
                    </div>
                    <div>
                        <span class="status-indicator status-info" id="user-status">Ready</span>
                    </div>
                </div>
                
                <div>
                    <button class="test-button" onclick="testUserProfile()">
                        <i class="fas fa-user"></i> Get Profile
                    </button>
                    <button class="test-button" onclick="testUpdateProfile()">
                        <i class="fas fa-edit"></i> Update Profile
                    </button>
                    <button class="test-button" onclick="testPriorityStatus()">
                        <i class="fas fa-star"></i> Check Priority
                    </button>
                </div>

                <div id="user-result" class="result-container" style="display: none;"></div>
            </div>

            <!-- Request Management Section -->
            <div class="debug-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title"><i class="fas fa-list-alt section-icon"></i> Request Management</h2>
                    </div>
                    <div>
                        <span class="status-indicator status-info" id="request-status">Ready</span>
                    </div>
                </div>
                
                <div>
                    <button class="test-button" onclick="testAllRequests()">
                        <i class="fas fa-list"></i> All Requests
                    </button>
                    <button class="test-button" onclick="testOwnRequest()">
                        <i class="fas fa-user-check"></i> Own Request
                    </button>
                    <button class="test-button" onclick="testCreateRequest()">
                        <i class="fas fa-plus"></i> Create Request
                    </button>
                </div>

                <div id="request-result" class="result-container" style="display: none;"></div>
            </div>

            <!-- Notifications Section -->
            <div class="debug-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title"><i class="fas fa-bell section-icon"></i> Notifications</h2>
                    </div>
                    <div>
                        <span class="status-indicator status-info" id="notification-status">Ready</span>
                    </div>
                </div>
                
                <div>
                    <button class="test-button" onclick="testNotifications()">
                        <i class="fas fa-bell"></i> Get Notifications
                    </button>
                    <button class="test-button" onclick="testNotificationCount()">
                        <i class="fas fa-chart-bar"></i> Count Stats
                    </button>
                </div>

                <div id="notification-result" class="result-container" style="display: none;"></div>
            </div>

            <!-- Calendar & Appointments Section -->
            <div class="debug-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title"><i class="fas fa-calendar-alt section-icon"></i> Calendar & Appointments</h2>
                    </div>
                    <div>
                        <span class="status-indicator status-info" id="calendar-status">Ready</span>
                    </div>
                </div>
                
                <div>
                    <button class="test-button" onclick="testCalendarAvailability()">
                        <i class="fas fa-calendar-check"></i> Check Availability
                    </button>
                    <button class="test-button" onclick="testAppointmentCreation()">
                        <i class="fas fa-calendar-plus"></i> Create Appointment
                    </button>
                </div>

                <div id="calendar-result" class="result-container" style="display: none;"></div>
            </div>

                    <!-- System Statistics Section -->
        <div class="debug-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title"><i class="fas fa-chart-line section-icon"></i> System Statistics</h2>
                </div>
                <div>
                    <span class="status-indicator status-info" id="stats-status">Ready</span>
                </div>
            </div>
            
            <div>
                <button class="test-button" onclick="testSystemStats()">
                    <i class="fas fa-chart-pie"></i> Get Statistics
                </button>
                <button class="test-button" onclick="testDateTimeInfo()">
                    <i class="fas fa-clock"></i> Date/Time Info
                </button>
                <button class="test-button" onclick="testHourlyRequests()">
                    <i class="fas fa-hourglass-half"></i> Hourly Requests
                </button>
            </div>

            <div id="stats-result" class="result-container" style="display: none;"></div>
            <div id="stats-grid" class="stats-grid" style="display: none;"></div>
        </div>

                <!-- Hourly Request Tracking Section -->
        <div class="debug-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title"><i class="fas fa-clock section-icon"></i> Hourly Request Tracking</h2>
                </div>
                <div>
                    <span class="status-indicator status-info" id="hourly-status">Ready</span>
                </div>
            </div>
            
            <!-- Date Label -->
            <div style="margin-bottom: 15px; padding: 10px 15px; background: var(--light-bg); border-radius: 8px; border-left: 4px solid var(--primary);">
                <div style="font-size: 14px; color: var(--text-dark); font-weight: 600;">
                    <i class="fas fa-calendar-alt"></i> Analyzing requests for: <span id="current-date-display">Today</span>
                </div>
            </div>
            
            <div>
                <button class="test-button" onclick="testCurrentHourRequests()">
                    <i class="fas fa-chart-bar"></i> Current Hour
                </button>
                <button class="test-button" onclick="testTodayHourlyBreakdown()">
                    <i class="fas fa-calendar-day"></i> Today's Breakdown
                </button>
                <button class="test-button" onclick="testTimeSlotAvailability()">
                    <i class="fas fa-list-check"></i> Time Slots (7AM-5PM)
                </button>
                <button class="test-button" onclick="testAllRequestsDebug()">
                    <i class="fas fa-bug"></i> Debug All Requests
                </button>
            </div>

            <div id="hourly-result" class="result-container" style="display: none;"></div>
            <div id="hourly-chart" class="hourly-chart" style="display: none;"></div>
        </div>
        </div>

        <!-- Global Status -->
        <div class="debug-section">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-server section-icon"></i> System Status</h2>
            </div>
            <div id="global-status">
                <p><strong>Base URL:</strong> <span id="base-url">Loading...</span></p>
                <p><strong>Current Time:</strong> <span id="current-time">Loading...</span></p>
                <p><strong>Token Status:</strong> <span id="token-status">Loading...</span></p>
                <p><strong>Connection Status:</strong> <span id="connection-status">Loading...</span></p>
            </div>
        </div>
    </div>

    <script>
        // Define baseUrl for API calls
        const baseUrl = "https://jimboyaczon.pythonanywhere.com";
        
        // Polyfill for cordovaFetch when running in browser
        if (typeof cordovaFetch === 'undefined') {
            window.cordovaFetch = function(url, options) {
                console.log('Using polyfill fetch for:', url);
                return fetch(url, options);
            };
        }

        // Initialize debug panel
        document.addEventListener('DOMContentLoaded', function() {
            updateGlobalStatus();
            setInterval(updateGlobalStatus, 5000); // Update every 5 seconds
            
            // Initialize date display
            updateDateDisplay();
        });

        function updateGlobalStatus() {
            document.getElementById('base-url').textContent = baseUrl;
            document.getElementById('current-time').textContent = new Date().toLocaleString();
            
            const token = localStorage.getItem('userToken');
            document.getElementById('token-status').textContent = token ? 'Present' : 'Not Found';
            
            // Test connection
            testConnection();
        }

        function testConnection() {
            cordovaFetch(`${baseUrl}/api/health`, { method: 'GET' })
                .then(response => {
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').className = 'status-success';
                })
                .catch(error => {
                    document.getElementById('connection-status').textContent = 'Disconnected';
                    document.getElementById('connection-status').className = 'status-error';
                });
        }

        // Date Display Function
        function updateDateDisplay() {
            const currentDateDisplay = document.getElementById('current-date-display');
            const today = new Date();
            const formattedDate = today.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            currentDateDisplay.textContent = formattedDate;
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // Authentication Tests
        function testLogin() {
            updateStatus('auth-status', 'loading');
            const testCredentials = {
                idno: 'TEST001',
                password: 'testpassword'
            };

            cordovaFetch(`${baseUrl}/api/auth/user_login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testCredentials)
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('auth-status', 'success');
                showResult('auth-result', 'Login Test Result:', data);
                if (data.token) {
                    localStorage.setItem('userToken', data.token);
                    showTokenDisplay(data.token);
                }
            })
            .catch(error => {
                updateStatus('auth-status', 'error');
                showError('auth-result', 'Login Test Failed:', error.message);
            });
        }

        function testTokenVerification() {
            updateStatus('auth-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('auth-status', 'error');
                showError('auth-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/auth/verify`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('auth-status', 'success');
                showResult('auth-result', 'Token Verification Result:', data);
            })
            .catch(error => {
                updateStatus('auth-status', 'error');
                showError('auth-result', 'Token Verification Failed:', error.message);
            });
        }

        function clearAuth() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userData');
            updateStatus('auth-status', 'info');
            showSuccess('auth-result', 'Authentication data cleared successfully');
            document.getElementById('token-display').style.display = 'none';
        }

        // User Management Tests
        function testUserProfile() {
            updateStatus('user-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('user-status', 'error');
                showError('user-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/user_profile`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('user-status', 'success');
                showResult('user-result', 'User Profile Result:', data);
            })
            .catch(error => {
                updateStatus('user-status', 'error');
                showError('user-result', 'User Profile Test Failed:', error.message);
            });
        }

        function testUpdateProfile() {
            updateStatus('user-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('user-status', 'error');
                showError('user-result', 'No token found. Please login first.');
                return;
            }

            const testUpdate = {
                name: 'Test User Updated',
                email: 'test.updated@example.com',
                cell: '1234567890'
            };

            cordovaFetch(`${baseUrl}/api/update_profile`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(testUpdate)
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('user-status', 'success');
                showResult('user-result', 'Profile Update Result:', data);
            })
            .catch(error => {
                updateStatus('user-status', 'error');
                showError('user-result', 'Profile Update Test Failed:', error.message);
            });
        }

        function testPriorityStatus() {
            updateStatus('user-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('user-status', 'error');
                showError('user-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/check_priority_status`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('user-status', 'success');
                showResult('user-result', 'Priority Status Result:', data);
            })
            .catch(error => {
                updateStatus('user-status', 'error');
                showError('user-result', 'Priority Status Test Failed:', error.message);
            });
        }

        // Request Management Tests
        function testAllRequests() {
            updateStatus('request-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('request-status', 'error');
                showError('request-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/user/requests`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('request-status', 'success');
                showResult('request-result', 'All Requests Result:', data);
            })
            .catch(error => {
                updateStatus('request-status', 'error');
                showError('request-result', 'All Requests Test Failed:', error.message);
            });
        }

        function testOwnRequest() {
            updateStatus('request-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('request-status', 'error');
                showError('request-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/user/check_own_request`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('request-status', 'success');
                showResult('request-result', 'Own Request Result:', data);
            })
            .catch(error => {
                updateStatus('request-status', 'error');
                showError('request-result', 'Own Request Test Failed:', error.message);
            });
        }

        function testCreateRequest() {
            updateStatus('request-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('request-status', 'error');
                showError('request-result', 'No token found. Please login first.');
                return;
            }

            const testRequest = {
                level: 'College',
                type: 'regular',
                payment: 'full',
                schedule: new Date().toISOString(),
                method: 'full'
            };

            cordovaFetch(`${baseUrl}/api/appointments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(testRequest)
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('request-status', 'success');
                showResult('request-result', 'Create Request Result:', data);
            })
            .catch(error => {
                updateStatus('request-status', 'error');
                showError('request-result', 'Create Request Test Failed:', error.message);
            });
        }

        // Notifications Tests
        function testNotifications() {
            updateStatus('notification-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('notification-status', 'error');
                showError('notification-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/user/notifications`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('notification-status', 'success');
                showResult('notification-result', 'Notifications Result:', data);
            })
            .catch(error => {
                updateStatus('notification-status', 'error');
                showError('notification-result', 'Notifications Test Failed:', error.message);
            });
        }

        function testNotificationCount() {
            updateStatus('notification-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('notification-status', 'error');
                showError('notification-result', 'No token found. Please login first.');
                return;
            }

            cordovaFetch(`${baseUrl}/api/user/notifications`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('notification-status', 'success');
                
                const waitingCount = data.all_requests ? data.all_requests.filter(r => r.status === 'pending').length : 0;
                const onCallCount = data.all_requests ? data.all_requests.filter(r => r.status === 'oncall').length : 0;
                const totalCount = data.all_requests ? data.all_requests.length : 0;
                
                const stats = {
                    total_requests: totalCount,
                    waiting_requests: waitingCount,
                    oncall_requests: onCallCount,
                    has_own_request: data.has_own_request || false
                };
                
                showResult('notification-result', 'Notification Count Stats:', stats);
            })
            .catch(error => {
                updateStatus('notification-status', 'error');
                showError('notification-result', 'Notification Count Test Failed:', error.message);
            });
        }

        // Calendar & Appointments Tests
        function testCalendarAvailability() {
            updateStatus('calendar-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('calendar-status', 'error');
                showError('calendar-result', 'No token found. Please login first.');
                return;
            }

            const currentDate = new Date().toISOString().split('T')[0];

            cordovaFetch(`${baseUrl}/api/calendar/availability?date=${currentDate}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('calendar-status', 'success');
                showResult('calendar-result', 'Calendar Availability Result:', data);
            })
            .catch(error => {
                updateStatus('calendar-status', 'error');
                showError('calendar-result', 'Calendar Availability Test Failed:', error.message);
            });
        }

        function testAppointmentCreation() {
            updateStatus('calendar-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('calendar-status', 'error');
                showError('calendar-result', 'No token found. Please login first.');
                return;
            }

            const testAppointment = {
                level: 'College',
                type: 'regular',
                payment: 'full',
                schedule: new Date().toISOString(),
                method: 'full'
            };

            cordovaFetch(`${baseUrl}/api/appointments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(testAppointment)
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('calendar-status', 'success');
                showResult('calendar-result', 'Appointment Creation Result:', data);
            })
            .catch(error => {
                updateStatus('calendar-status', 'error');
                showError('calendar-result', 'Appointment Creation Test Failed:', error.message);
            });
        }

        // System Statistics Tests
        function testSystemStats() {
            updateStatus('stats-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('stats-status', 'error');
                showError('stats-result', 'No token found. Please login first.');
                return;
            }

            // Test multiple endpoints to gather comprehensive stats
            Promise.all([
                cordovaFetch(`${baseUrl}/api/user/notifications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json()),
                cordovaFetch(`${baseUrl}/api/user/requests`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).then(r => r.json())
            ])
            .then(([notifications, requests]) => {
                updateStatus('stats-status', 'success');
                
                const stats = {
                    total_requests: requests.length || 0,
                    waiting_requests: requests.filter(r => r.status === 'pending').length || 0,
                    oncall_requests: requests.filter(r => r.status === 'oncall').length || 0,
                    completed_requests: requests.filter(r => r.status === 'completed').length || 0,
                    has_own_request: notifications.has_own_request || false,
                    server_time: new Date().toISOString(),
                    client_time: new Date().toLocaleString()
                };
                
                showResult('stats-result', 'System Statistics:', stats);
                showStatsGrid(stats);
            })
            .catch(error => {
                updateStatus('stats-status', 'error');
                showError('stats-result', 'System Stats Test Failed:', error.message);
            });
        }

        function testDateTimeInfo() {
            updateStatus('stats-status', 'loading');
            
            const dateTimeInfo = {
                server_time: new Date().toISOString(),
                client_time: new Date().toLocaleString(),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timestamp: Date.now(),
                date_components: {
                    year: new Date().getFullYear(),
                    month: new Date().getMonth() + 1,
                    day: new Date().getDate(),
                    hour: new Date().getHours(),
                    minute: new Date().getMinutes(),
                    second: new Date().getSeconds()
                }
            };
            
            updateStatus('stats-status', 'success');
            showResult('stats-result', 'Date/Time Information:', dateTimeInfo);
        }

        // Hourly Request Tracking Functions
        function testHourlyRequests() {
            updateStatus('stats-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('stats-status', 'error');
                showError('stats-result', 'No token found. Please login first.');
                return;
            }

            // Get all requests and analyze by hour
            cordovaFetch(`${baseUrl}/api/user/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(requests => {
                updateStatus('stats-status', 'success');
                
                const hourlyStats = analyzeHourlyRequests(requests);
                showResult('stats-result', 'Hourly Request Analysis:', hourlyStats);
                showHourlyChart(hourlyStats);
            })
            .catch(error => {
                updateStatus('stats-status', 'error');
                showError('stats-result', 'Hourly Request Analysis Failed:', error.message);
            });
        }

        function testCurrentHourRequests() {
            updateStatus('hourly-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'No token found. Please login first.');
                return;
            }

            const now = new Date();
            const currentHour = now.getHours();
            const currentDate = now.toISOString().split('T')[0];
            const isAM = now.getHours() < 12;
            const currentAMPM = isAM ? 'AM' : 'PM';

            cordovaFetch(`${baseUrl}/api/user/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(requests => {
                updateStatus('hourly-status', 'success');
                
                const currentHourRequests = requests.filter(request => {
                    if (!request.schedule) return false;
                    
                    // Parse the schedule string directly to avoid timezone issues
                    const scheduleParts = request.schedule.split('T');
                    const datePart = scheduleParts[0];
                    const timePart = scheduleParts[1];
                    
                    // Extract hour from the time part (HH:MM:SS format)
                    const hourStr = timePart.split(':')[0];
                    const requestHour = parseInt(hourStr, 10);
                    const requestIsAM = requestHour < 12;
                    const requestAMPM = requestIsAM ? 'AM' : 'PM';
                    
                    // Debug logging
                    console.log('Request Analysis:', {
                        original_schedule: request.schedule,
                        date_part: datePart,
                        time_part: timePart,
                        hour_string: hourStr,
                        request_hour: requestHour,
                        request_is_am: requestIsAM,
                        request_ampm: requestAMPM,
                        current_hour: currentHour,
                        current_date: currentDate,
                        is_am: isAM,
                        current_ampm: currentAMPM,
                        hour_match: requestHour === currentHour,
                        date_match: datePart === currentDate,
                        ampm_match: requestIsAM === isAM
                    });
                    
                    // Check if it's the same hour and same AM/PM period
                    return requestHour === currentHour && 
                           datePart === currentDate &&
                           requestIsAM === isAM;
                });

                // Format current hour for display
                let displayHour = currentHour;
                if (currentHour === 0) displayHour = 12;
                else if (currentHour > 12) displayHour = currentHour - 12;

                const stats = {
                    current_hour_24: currentHour,
                    current_hour_12: displayHour,
                    current_ampm: currentAMPM,
                    current_time: now.toLocaleString(),
                    requests_in_current_hour: currentHourRequests.length,
                    requests_details: currentHourRequests,
                    hour_range: `${displayHour}:00 ${currentAMPM} - ${displayHour === 12 ? 1 : displayHour + 1}:00 ${currentAMPM}`,
                    debug_info: {
                        current_hour_24: currentHour,
                        is_am: isAM,
                        total_requests: requests.length,
                        filtered_requests: currentHourRequests.length
                    }
                };

                showResult('hourly-result', 'Current Hour Requests:', stats);
            })
            .catch(error => {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'Current Hour Analysis Failed:', error.message);
            });
        }

        function testTodayHourlyBreakdown() {
            updateStatus('hourly-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'No token found. Please login first.');
                return;
            }

            const today = getTodayDate();
            const dateObj = new Date(today);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            cordovaFetch(`${baseUrl}/api/user/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(requests => {
                updateStatus('hourly-status', 'success');
                
                const todayRequests = requests.filter(request => {
                    if (!request.schedule) return false;
                    // Parse the schedule string directly to avoid timezone issues
                    const scheduleParts = request.schedule.split('T');
                    const datePart = scheduleParts[0];
                    return datePart === today;
                });

                const hourlyBreakdown = {};
                
                // Initialize all hours from 7 AM to 5 PM with proper AM/PM display
                for (let hour = 7; hour <= 17; hour++) {
                    const isAM = hour < 12;
                    const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
                    const ampm = isAM ? 'AM' : 'PM';
                    
                    hourlyBreakdown[hour] = {
                        hour: hour,
                        display_hour: displayHour,
                        ampm: ampm,
                        time_slot: `${displayHour}:00 ${ampm} - ${displayHour === 12 ? 1 : displayHour + 1}:00 ${ampm}`,
                        count: 0,
                        requests: []
                    };
                }

                // Count requests by hour using direct string parsing
                todayRequests.forEach(request => {
                    const scheduleParts = request.schedule.split('T');
                    const timePart = scheduleParts[1];
                    const hourStr = timePart.split(':')[0];
                    const requestHour = parseInt(hourStr, 10);
                    
                    if (hourlyBreakdown[requestHour]) {
                        hourlyBreakdown[requestHour].count++;
                        hourlyBreakdown[requestHour].requests.push(request);
                    }
                });

                const breakdown = {
                    date: today,
                    formatted_date: formattedDate,
                    total_requests: todayRequests.length,
                    hourly_breakdown: Object.values(hourlyBreakdown),
                    peak_hour: Object.values(hourlyBreakdown).reduce((max, hour) => 
                        hour.count > max.count ? hour : max, { count: 0 }),
                    quiet_hour: Object.values(hourlyBreakdown).reduce((min, hour) => 
                        hour.count < min.count ? hour : min, { count: Infinity }),
                    am_pm_breakdown: {
                        am_requests: Object.values(hourlyBreakdown).filter(h => h.ampm === 'AM').reduce((sum, h) => sum + h.count, 0),
                        pm_requests: Object.values(hourlyBreakdown).filter(h => h.ampm === 'PM').reduce((sum, h) => sum + h.count, 0)
                    }
                };

                showResult('hourly-result', `${formattedDate} Hourly Breakdown:`, breakdown);
                showTodayHourlyChart(breakdown.hourly_breakdown);
            })
            .catch(error => {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'Today\'s Breakdown Failed:', error.message);
            });
        }

        function testTimeSlotAvailability() {
            updateStatus('hourly-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'No token found. Please login first.');
                return;
            }

            const today = getTodayDate();
            const currentHour = new Date().getHours();
            const currentIsAM = currentHour < 12;
            const dateObj = new Date(today);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            cordovaFetch(`${baseUrl}/api/user/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(requests => {
                updateStatus('hourly-status', 'success');
                
                const todayRequests = requests.filter(request => {
                    if (!request.schedule) return false;
                    // Parse the schedule string directly to avoid timezone issues
                    const scheduleParts = request.schedule.split('T');
                    const datePart = scheduleParts[0];
                    return datePart === today;
                });

                const timeSlots = [];
                
                // Generate time slots from 7 AM to 5 PM with proper AM/PM display
                for (let hour = 7; hour <= 17; hour++) {
                    const requestsInHour = todayRequests.filter(request => {
                        const scheduleParts = request.schedule.split('T');
                        const timePart = scheduleParts[1];
                        const hourStr = timePart.split(':')[0];
                        const requestHour = parseInt(hourStr, 10);
                        return requestHour === hour;
                    });
                    
                    let status = 'available';
                    let count = requestsInHour.length;
                    
                    if (count >= 10) {
                        status = 'full';
                    } else if (count >= 5) {
                        status = 'busy';
                    } else if (hour < 7 || hour > 17) {
                        status = 'unavailable';
                    }

                    // Format display time with AM/PM
                    const isAM = hour < 12;
                    const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
                    const ampm = isAM ? 'AM' : 'PM';
                    const nextHour = displayHour === 12 ? 1 : displayHour + 1;
                    const nextAMPM = (hour + 1) < 12 ? 'AM' : 'PM';

                    timeSlots.push({
                        hour: hour,
                        time: `${hour}:00`,
                        display_time: `${displayHour}:00 ${ampm} - ${nextHour}:00 ${nextAMPM}`,
                        display_hour: displayHour,
                        ampm: ampm,
                        count: count,
                        status: status,
                        is_current_hour: hour === currentHour && isAM === currentIsAM,
                        requests: requestsInHour
                    });
                }

                const availability = {
                    date: today,
                    formatted_date: formattedDate,
                    current_time: new Date().toLocaleString(),
                    current_hour: currentHour,
                    current_ampm: currentIsAM ? 'AM' : 'PM',
                    total_slots: timeSlots.length,
                    available_slots: timeSlots.filter(slot => slot.status === 'available').length,
                    busy_slots: timeSlots.filter(slot => slot.status === 'busy').length,
                    full_slots: timeSlots.filter(slot => slot.status === 'full').length,
                    am_pm_summary: {
                        am_slots: timeSlots.filter(slot => slot.ampm === 'AM').length,
                        pm_slots: timeSlots.filter(slot => slot.ampm === 'PM').length,
                        am_requests: timeSlots.filter(slot => slot.ampm === 'AM').reduce((sum, slot) => sum + slot.count, 0),
                        pm_requests: timeSlots.filter(slot => slot.ampm === 'PM').reduce((sum, slot) => sum + slot.count, 0)
                    },
                    time_slots: timeSlots
                };

                showResult('hourly-result', `${formattedDate} Time Slot Availability:`, availability);
                showTimeSlotGrid(timeSlots);
            })
            .catch(error => {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'Time Slot Analysis Failed:', error.message);
            });
        }

        function analyzeHourlyRequests(requests) {
            const hourlyData = {};
            
            // Initialize all hours
            for (let hour = 0; hour < 24; hour++) {
                hourlyData[hour] = {
                    hour: hour,
                    count: 0,
                    requests: []
                };
            }

            // Group requests by hour
            requests.forEach(request => {
                if (request.schedule) {
                    const hour = new Date(request.schedule).getHours();
                    hourlyData[hour].count++;
                    hourlyData[hour].requests.push(request);
                }
            });

            return {
                total_requests: requests.length,
                hourly_breakdown: Object.values(hourlyData),
                peak_hour: Object.values(hourlyData).reduce((max, hour) => 
                    hour.count > max.count ? hour : max, { count: 0 }),
                business_hours_analysis: {
                    '7am-12pm': Object.values(hourlyData).slice(7, 12).reduce((sum, hour) => sum + hour.count, 0),
                    '12pm-5pm': Object.values(hourlyData).slice(12, 17).reduce((sum, hour) => sum + hour.count, 0),
                    '5pm-7am': Object.values(hourlyData).slice(17, 24).reduce((sum, hour) => sum + hour.count, 0) + 
                               Object.values(hourlyData).slice(0, 7).reduce((sum, hour) => sum + hour.count, 0)
                }
            };
        }

        function showHourlyChart(hourlyStats) {
            const container = document.getElementById('hourly-chart');
            container.style.display = 'block';
            
            const maxCount = Math.max(...hourlyStats.hourly_breakdown.map(h => h.count));
            
            container.innerHTML = `
                <h4>Hourly Request Distribution</h4>
                <div class="hourly-bar-chart">
                    ${hourlyStats.hourly_breakdown.map(hour => {
                        const height = maxCount > 0 ? (hour.count / maxCount) * 100 : 0;
                        return `
                            <div class="hourly-bar" style="height: ${height}%">
                                <div class="value">${hour.count}</div>
                                <div class="label">${hour.hour}:00</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 20px;">
                    <p><strong>Peak Hour:</strong> ${hourlyStats.peak_hour.hour}:00 (${hourlyStats.peak_hour.count} requests)</p>
                    <p><strong>Business Hours Analysis:</strong></p>
                    <ul>
                        <li>7 AM - 12 PM: ${hourlyStats.business_hours_analysis['7am-12pm']} requests</li>
                        <li>12 PM - 5 PM: ${hourlyStats.business_hours_analysis['12pm-5pm']} requests</li>
                        <li>5 PM - 7 AM: ${hourlyStats.business_hours_analysis['5pm-7am']} requests</li>
                    </ul>
                </div>
            `;
        }

        function showTodayHourlyChart(hourlyBreakdown) {
            const container = document.getElementById('hourly-chart');
            container.style.display = 'block';
            
            const maxCount = Math.max(...hourlyBreakdown.map(h => h.count));
            const currentHour = new Date().getHours();
            const currentIsAM = currentHour < 12;
            const today = getTodayDate();
            const dateObj = new Date(today);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            
            container.innerHTML = `
                <h4>${formattedDate} Hourly Breakdown (7 AM - 5 PM)</h4>
                <div class="hourly-bar-chart">
                    ${hourlyBreakdown.map(hour => {
                        const height = maxCount > 0 ? (hour.count / maxCount) * 100 : 0;
                        const isCurrent = hour.hour === currentHour && hour.ampm === (currentIsAM ? 'AM' : 'PM');
                        return `
                            <div class="hourly-bar" style="height: ${height}%">
                                <div class="value">${hour.count}</div>
                                <div class="label">
                                    ${hour.display_hour}:00 ${hour.ampm}
                                    ${isCurrent ? '<span class="current-hour-indicator">NOW</span>' : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="margin-top: 20px;">
                    <p><strong>AM/PM Summary:</strong></p>
                    <ul>
                        <li>AM Requests: ${hourlyBreakdown.filter(h => h.ampm === 'AM').reduce((sum, h) => sum + h.count, 0)}</li>
                        <li>PM Requests: ${hourlyBreakdown.filter(h => h.ampm === 'PM').reduce((sum, h) => sum + h.count, 0)}</li>
                    </ul>
                </div>
            `;
        }

        function showTimeSlotGrid(timeSlots) {
            const container = document.getElementById('hourly-chart');
            container.style.display = 'block';
            
            const amSlots = timeSlots.filter(slot => slot.ampm === 'AM');
            const pmSlots = timeSlots.filter(slot => slot.ampm === 'PM');
            const today = getTodayDate();
            const dateObj = new Date(today);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            
            container.innerHTML = `
                <h4>${formattedDate} Time Slot Availability (7 AM - 5 PM)</h4>
                
                <div style="margin-bottom: 20px;">
                    <h5>AM Slots (7 AM - 12 PM)</h5>
                    <div class="time-slot-grid">
                        ${amSlots.map(slot => `
                            <div class="time-slot ${slot.status}">
                                <div class="time">
                                    ${slot.display_time}
                                    ${slot.is_current_hour ? '<span class="current-hour-indicator">NOW</span>' : ''}
                                </div>
                                <div class="count">${slot.count} requests</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h5>PM Slots (12 PM - 5 PM)</h5>
                    <div class="time-slot-grid">
                        ${pmSlots.map(slot => `
                            <div class="time-slot ${slot.status}">
                                <div class="time">
                                    ${slot.display_time}
                                    ${slot.is_current_hour ? '<span class="current-hour-indicator">NOW</span>' : ''}
                                </div>
                                <div class="count">${slot.count} requests</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <p><strong>Legend:</strong></p>
                    <ul>
                        <li><span style="color: var(--success);">● Available</span> (0-4 requests)</li>
                        <li><span style="color: var(--warning);">● Busy</span> (5-9 requests)</li>
                        <li><span style="color: var(--danger);">● Full</span> (10+ requests)</li>
                        <li><span style="color: var(--text-muted);">● Unavailable</span> (Outside hours)</li>
                    </ul>
                </div>
            `;
        }

        function testAllRequestsDebug() {
            updateStatus('hourly-status', 'loading');
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'No token found. Please login first.');
                return;
            }

            const today = getTodayDate();
            const dateObj = new Date(today);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            cordovaFetch(`${baseUrl}/api/user/requests`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(requests => {
                updateStatus('hourly-status', 'success');
                
                const todayRequests = requests.filter(request => {
                    if (!request.schedule) return false;
                    // Parse the schedule string directly to avoid timezone issues
                    const scheduleParts = request.schedule.split('T');
                    const datePart = scheduleParts[0];
                    return datePart === today;
                });

                // Analyze each request in detail
                const detailedAnalysis = todayRequests.map(request => {
                    // Parse the schedule string directly to avoid timezone issues
                    const scheduleParts = request.schedule.split('T');
                    const timePart = scheduleParts[1];
                    const hourStr = timePart.split(':')[0];
                    const minuteStr = timePart.split(':')[1];
                    
                    const requestHour = parseInt(hourStr, 10);
                    const requestMinute = parseInt(minuteStr, 10);
                    const requestIsAM = requestHour < 12;
                    const requestAMPM = requestIsAM ? 'AM' : 'PM';
                    const displayHour = requestHour === 0 ? 12 : (requestHour > 12 ? requestHour - 12 : requestHour);
                    
                    return {
                        request_id: request.request_id || 'N/A',
                        user_name: request.name || request.user_name || 'N/A',
                        original_schedule: request.schedule,
                        parsed_date: requestDate.toISOString(),
                        hour_24: requestHour,
                        hour_12: displayHour,
                        minute: requestMinute,
                        is_am: requestIsAM,
                        ampm: requestAMPM,
                        display_time: `${displayHour}:${requestMinute.toString().padStart(2, '0')} ${requestAMPM}`,
                        status: request.status || 'N/A',
                        level: request.level || 'N/A',
                        type: request.type || 'N/A'
                    };
                });

                // Group by hour for analysis
                const hourlyAnalysis = {};
                for (let hour = 0; hour < 24; hour++) {
                    const requestsInHour = detailedAnalysis.filter(req => req.hour_24 === hour);
                    if (requestsInHour.length > 0) {
                        hourlyAnalysis[hour] = {
                            hour_24: hour,
                            hour_12: hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour),
                            ampm: hour < 12 ? 'AM' : 'PM',
                            count: requestsInHour.length,
                            requests: requestsInHour
                        };
                    }
                }

                const debugResult = {
                    date: today,
                    formatted_date: formattedDate,
                    total_requests: todayRequests.length,
                    detailed_analysis: detailedAnalysis,
                    hourly_breakdown: hourlyAnalysis,
                    seven_am_analysis: {
                        requests: detailedAnalysis.filter(req => req.hour_24 === 7),
                        count: detailedAnalysis.filter(req => req.hour_24 === 7).length
                    },
                    eight_am_analysis: {
                        requests: detailedAnalysis.filter(req => req.hour_24 === 8),
                        count: detailedAnalysis.filter(req => req.hour_24 === 8).length
                    }
                };

                showResult('hourly-result', `${formattedDate} Debug Analysis:`, debugResult);
            })
            .catch(error => {
                updateStatus('hourly-status', 'error');
                showError('hourly-result', 'Debug Analysis Failed:', error.message);
            });
        }

        // Utility Functions
        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.textContent = status === 'loading' ? 'Loading...' : 
                                status === 'success' ? 'Success' :
                                status === 'error' ? 'Error' : 'Ready';
            element.className = `status-indicator status-${status}`;
        }

        function showResult(containerId, title, data) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function showError(containerId, title, message) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.innerHTML = `
                <div class="error-message">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
            `;
        }

        function showSuccess(containerId, message) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.innerHTML = `
                <div class="success-message">
                    <p>${message}</p>
                </div>
            `;
        }

        function showTokenDisplay(token) {
            const container = document.getElementById('token-display');
            container.style.display = 'block';
            container.textContent = `Token: ${token.substring(0, 50)}...`;
        }

        function showStatsGrid(stats) {
            const container = document.getElementById('stats-grid');
            container.style.display = 'grid';
            container.innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.total_requests}</span>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.waiting_requests}</span>
                    <div class="stat-label">Waiting</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.oncall_requests}</span>
                    <div class="stat-label">On Call</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.completed_requests}</span>
                    <div class="stat-label">Completed</div>
                </div>
            `;
        }
    </script>
</body>
</html>    